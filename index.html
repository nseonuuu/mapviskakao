<!DOCTYPE html>
<html lang="ko">


<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RToday Checker</title>
    <link rel="stylesheet" href="styles.css">
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a035643f71b9f10705041cf4f38eb95b&libraries=services,clusterer"></script>

  </head>

<body>
    <header>
        <h1>RToday Checker</h1>
    </header>
    <main>
        <div id="controls">
            <input id="pac-input" type="text" placeholder="위치 검색">
        </div>
        <div id="map"></div>
        <p>
    	    <button onclick="setCenter()">처음으로</button> 
	</p>
        <div id="dataframe-container"></div>
    </main>
    <footer>
        <p>&copy; Copyright 2017. cizipcommunity. All rights reserved.</p>
    </footer>

    <script>
      var container = document.getElementById('map'); //지도를 담을 영역의 DOM 레퍼런스
      var options = { //지도를 생성할 때 필요한 기본 옵션
	            center: new kakao.maps.LatLng(37.5642135, 127.0016985), //지도의 중심좌표.
	            level: 7 //지도의 레벨(확대, 축소 정도)

      };

      var map = new kakao.maps.Map(container, options); //지도 생성 및 객체 리턴

      // 지도에 교통정보를 표시하도록 지도타입을 추가합니다
      map.addOverlayMapTypeId(kakao.maps.MapTypeId.TRAFFIC);

      function setCenter() {           
	  // 이동할 위도 경도 위치를 생성합니다 
	  var moveLatLon = new kakao.maps.LatLng(37.5642135, 127.0016985);
    
          // 지도 중심을 이동 시킵니다
   	  map.setCenter(moveLatLon);
      }

// CSV 파일을 읽어오고 데이터를 처리하는 함수
function loadAndPlotData() {
    fetch('RT_SU_Update.csv')
        .then(response => response.text())
        .then(data => {
            const results = Papa.parse(data, {
                header: true,
                skipEmptyLines: true
            });

            results.data.forEach(row => {
                if (row['관련 지역'] && row['신고 인원']) {
                    let address = row['관련 지역'];
                    // '등' 제거
                    address = address.replace(/\s*등\s*$/, '');  
                    // "서울" 추가
                    address = "서울 " + address;

                    const population = parseInt(row['신고 인원'], 10);

		        // Check if population is a valid number
		        if (isNaN(population)) {
		            console.warn('Invalid population value for address:', address);
		            return;  // Skip the current iteration
		        }

			
                    geocodeAddress(address, function (location) {
			console.log("Returned location:", location);
			// 유효한 좌표인지 확인
                        if (!location || isNaN(location.Ma) || isNaN(location.La)) {
                            console.error('Invalid coordinates for address:', address);
                            return;  // Skip the current iteration
                        }

			    
                        const radius = Math.sqrt(population) * 10;  // 인원 수의 제곱근에 비례하여 반지름 설정
			    // 반지름 값이 NaN인 경우 원형 마커 생성을 스킵
				if (isNaN(radius)) {
				    console.error('Invalid radius value for address:', address);
				    return;  // Skip the current iteration
				}

			    
                        // 원형 마커 생성
                        var circle = new kakao.maps.Circle({
                            center: new kakao.maps.LatLng(location.Ma, location.La),
                            radius: radius,
                            strokeWeight: 2,
                            strokeColor: '#FF0000',
                            strokeOpacity: 0.3,
                            fillColor: '#FF0000',
                            fillOpacity: 0.2,
                            map: map
                        });

                        // 마커 생성
                        var marker = new kakao.maps.Marker({
                            position: new kakao.maps.LatLng(location.Ma, location.La),
                            map: map,
                            title: address
                        });
                    });
                }
            });

		// Generate the HTML table from the parsed data
		var html = '<table class="dataframe">';
		html += '<thead><tr>';
		results.meta.fields.forEach(field => {
		    html += '<th>' + field + '</th>';
		});
		html += '</tr></thead>';
		
		html += '<tbody>';
		results.data.forEach(row => {
		    html += '<tr>';
		    results.meta.fields.forEach(field => {
		        html += '<td>' + row[field] + '</td>';
		    }); 
		    html += '</tr>';
		});
		html += '</tbody>';
		html += '</table>';
		
		// Insert the generated table into the webpage
		document.getElementById("dataframe-container").innerHTML = html;

	})
        .catch(error => {
            console.error('Error loading or parsing the CSV:', error);
        });
}

// 주소를 좌표로 변환하는 함수
function geocodeAddress(address, callback) {
    var geocoder = new kakao.maps.services.Geocoder();
    geocoder.addressSearch(address, function (result, status) {
        // 정상적으로 검색이 완료됐으면 
        if (status === kakao.maps.services.Status.OK) {
            var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
            callback(coords); // 좌표 반환

	    // 로그를 출력하여 location 객체의 값을 확인합니다.
            console.log("Address:", address, "Coordinates:", coords);
		
        } else {
            console.error('Failed to get coordinates for address:', address);
        }
    });
}

// CSV 파일 데이터를 로드하고 표시
loadAndPlotData();



                	    
    </script>

</body>

</html>
